import sxtwl
import requests
import datetime
import json

# é…ç½®ä¿¡æ¯
FEISHU_WEBHOOK = "https://open.feishu.cn/open-apis/bot/v2/hook/4738fb14-a6b1-4391-a05c-2507ef5a46ff"

# å§å§çš„å‘½ç›˜ä¿¡æ¯
# å…«å­—: å£¬ç”³ æˆŠç”³ å£¬åˆ å£¬å¯…
# å–œç”¨: æœ¨ (é£Ÿä¼¤)ã€ç« (è´¢)ã€ç‡¥åœŸ (å®˜æ€)
# å¿Œç¥: é‡‘ (å°)ã€æ°´ (æ¯”åŠ«)ã€æ¹¿åœŸ (æ™¦ç«)

GAN = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"]
ZHI = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"]

SHEN_DICT = {
    "å£¬": {"ç”²": "é£Ÿç¥", "ä¹™": "ä¼¤å®˜", "ä¸™": "åè´¢", "ä¸": "æ­£è´¢", "æˆŠ": "ä¸ƒæ€", "å·±": "æ­£å®˜", "åºš": "åå°", "è¾›": "æ­£å°", "å£¬": "æ¯”è‚©", "ç™¸": "åŠ«è´¢"},
}

def get_daily_info():
    now = datetime.datetime.now()
    day = sxtwl.fromSolar(now.year, now.month, now.day)
    
    # è·å–æ—¥æŸ±å¹²æ”¯
    gz_day_idx = day.getDayGZ()
    tg_idx = gz_day_idx.tg
    dz_idx = gz_day_idx.dz
    
    return {
        "date": now.strftime("%Y-%m-%d"),
        "gz_day": GAN[tg_idx] + ZHI[dz_idx],
        "tg": GAN[tg_idx],
        "dz": ZHI[dz_idx]
    }

def generate_content(info):
    tg = info["tg"]
    dz = info["dz"]
    gz_day = info["gz_day"]
    
    # 1. èƒ½é‡å¤©æ°”é¢„æŠ¥é€»è¾‘
    weather = ""
    tg_desc = ""
    dz_desc = ""
    conflict = ""
    summary = ""
    
    # å¤©å¹²è§£æ (å£¬æ°´è§†è§’)
    ten_god = SHEN_DICT["å£¬"].get(tg, "è¿åŠ¿")
    if tg in ["ç”²", "ä¹™", "ä¸™", "ä¸"]:
        tg_desc = f"ä»£è¡¨å¿ƒæƒ…æ˜æœ—ï¼Œæ‰åå¾—ä»¥æ–½å±•æˆ–æœ‰è´¢æ°”ã€‚({ten_god})"
    elif tg in ["åºš", "è¾›", "å£¬", "ç™¸"]:
        tg_desc = f"ä»£è¡¨å‹åŠ›è¾ƒå¤§ï¼Œå®¹æ˜“æƒ³å¤ªå¤šæˆ–æœ‰ç«äº‰ã€‚({ten_god})"
    else:
        tg_desc = f"ä»£è¡¨å¹³ç¨³ï¼Œæ³¨é‡è´£ä»»ä¸è§„çŸ©ã€‚({ten_god})"
        
    # åœ°æ”¯è§£æ
    if dz == "ç”³":
        dz_desc = "ç”³é‡‘å½“ä»¤ï¼Œå°æ˜Ÿè¿‡æ—ºï¼Œèº«ä½“å®¹æ˜“æ„Ÿåˆ°æ²‰é‡æˆ–ç–²æƒ«ã€‚"
        conflict = "ä»Šæ—¥åœ°æ”¯ç”³é‡‘ï¼Œä¸å‘½å±€æ„æˆã€å¯…ç”³å†²ã€‘ï¼Œæ³¨æ„æƒ…ç»ªæ³¢åŠ¨å’Œç­‹éª¨å—ä¼¤ï¼"
        weather = "ä»Šå¤©å°±åƒé˜´é›¨å¤©æ²¡å¸¦ä¼ï¼Œæ¹¿æ¼‰æ¼‰çš„å¾ˆéš¾å—ã€‚"
        summary = "éœ€è¦èººå¹³"
    elif dz == "å¯…":
        dz_desc = "å¯…æœ¨é£Ÿç¥ï¼Œæœ¬æ˜¯å¥½äº‹ï¼Œä½†è¦æ³¨æ„åŸå±€çš„å†²åŠ¨ã€‚"
        conflict = "ä»Šæ—¥åœ°æ”¯å¯…æœ¨ï¼Œå†æ¬¡å¼•å‘ã€å¯…ç”³å†²ã€‘ï¼Œæ‰åè™½æœ‰ä½†æ˜“å—å‹åˆ¶ã€‚"
        weather = "é£èµ·äº‘æ¶Œï¼Œå†…å¿ƒæœ‰å¾ˆå¤šæƒ³æ³•åœ¨ç¢°æ’ã€‚"
        summary = "æƒ…ç»ªææ˜“å´©æºƒ"
    elif dz == "å·³":
        dz_desc = "å·³ç«è´¢æ˜Ÿï¼Œä½†ä¸ç”³æ„æˆåˆ‘ã€‚"
        conflict = "ä»Šæ—¥åœ°æ”¯å·³ç«ï¼Œæ„æˆã€å¯…å·³ç”³ä¸‰åˆ‘ã€‘ï¼Œå®¹æ˜“çº ç»“ã€æ„Ÿåˆ°æ— æ©ä¹‹æƒ…ã€‚"
        weather = "é›¾é‡Œçœ‹èŠ±ï¼Œçœ‹å¾—åˆ°æœºä¼šä½†è¿‡ç¨‹çº ç»“ã€‚"
        summary = "é€‚åˆæ–­èˆç¦»"
    elif dz == "åˆ":
        dz_desc = "åˆç«è´¢æ˜Ÿï¼Œå†…å¿ƒæ¸´æœ›é’±è´¢ã€‚"
        conflict = "ä»Šæ—¥åœ°æ”¯åˆç«ï¼Œå¼•å‘ã€åˆåˆè‡ªåˆ‘ã€‘ï¼Œå®¹æ˜“å†…è€—ã€æƒ³èŠ±é’±ã€‚"
        weather = "çƒˆæ—¥å½“ç©ºï¼Œå†…å¿ƒç‡¥çƒ­ï¼Œå®¹æ˜“å†²åŠ¨æ¶ˆè´¹ã€‚"
        summary = "é€‚åˆæé’±/ä¹°ä¹°ä¹°"
    elif dz == "äº¥":
        dz_desc = "äº¥æ°´æ¯”åŠ«ï¼Œæœ‰äººé™ªä¼´ã€‚"
        conflict = "ä»Šæ—¥åœ°æ”¯äº¥æ°´ï¼Œä¸å¯…ã€å¯…äº¥åˆã€‘ï¼Œæœ‰äººå¸®ã€æ„Ÿè§‰èˆ’æœã€‚"
        weather = "æ˜¥é›¨æ¶¦ç‰©ï¼Œæœ‰äººç†è§£ä½ çš„ä¸å®¹æ˜“ã€‚"
        summary = "é€‚åˆçº¦ä¼š/è°ˆäº‹"
    else:
        dz_desc = "åœ°æ”¯å¹³ç¨³ï¼ŒæŒ‰éƒ¨å°±ç­ã€‚"
        conflict = "ä»Šæ—¥åœ°æ”¯ä¸å‘½å±€æ— å‰§çƒˆå†²çªï¼Œå¹³ç¨³åº¦è¿‡ã€‚"
        weather = "å¤šäº‘è½¬æ™´ï¼Œå¿ƒæƒ…é€æ¸å¹³å¤ã€‚"
        summary = "é€‚åˆæé’±"

    # ç¦å¿Œä¸è½¬è¿å»ºè®®
    taboos = ["åˆ«åšé‡å¤§å†³å®š", "åˆ«ç”Ÿé—·æ°”"]
    advices = []
    
    if tg in ["åºš", "è¾›", "å£¬", "ç™¸"] or dz in ["ç”³", "é…‰", "äº¥", "å­"]:
        # å¿Œç¥æ—¥
        advices.append({"title": "å»æ™’å¤ªé˜³/åƒé¡¿çƒ­ä¹çš„", "logic": "ä»Šæ—¥é‡‘æ°´æ—ºï¼Œéœ€ç«æ¥æš–å±€ï¼Œè¡¥è¶³èƒ½é‡ã€‚"})
        advices.append({"title": "ç©¿çº¢è‰²æˆ–ç»¿è‰²çš„è¡£æœ", "logic": "æœ¨ç«ä¸ºå–œç”¨ï¼Œè§†è§‰è¡¥èƒ½ã€‚"})
    else:
        advices.append({"title": "å»åƒé¡¿å¥½çš„å¥–åŠ±è‡ªå·±", "logic": "å–œç”¨ç¥åˆ°ä½ï¼Œäº«å—ç”Ÿæ´»ã€‚"})
        advices.append({"title": "è®°å½•ä¸‹ä»Šå¤©çš„çµæ„Ÿ", "logic": "é£Ÿä¼¤ç”Ÿè´¢ï¼Œçµæ„Ÿå°±æ˜¯è´¢å¯Œã€‚"})

    if "å†²" in conflict or "åˆ‘" in conflict:
        taboos = ["åˆ«ç­¾åˆåŒ", "åˆ«å¼€è½¦å¤ªå¿«", "åˆ«å’Œäººäº‰æ‰§"]
        advices.append({"title": "å‰ªå¤´å‘æˆ–æ´—ç‰™", "logic": "ä»¥å°â€˜è¡€å…‰â€™æˆ–â€˜å˜åŠ¨â€™åº”æ‰åœ°æ”¯å†²åˆ‘çš„ç¾ã€‚"})
    
    advices.append({"title": "æ•´ç†æˆ¿é—´æ‰”æ‰æ—§ç‰©", "logic": "å»å°æ˜Ÿä¹‹å¿Œï¼Œè…¾å‡ºç©ºé—´ç»™æ–°èƒ½é‡ã€‚"})

    # ç»„è£…æ¨¡æ¿
    content = f"ğŸ“… **ä»Šå¤©æ˜¯ {info['date']} Â· {gz_day} æ—¥**\n\n---\n### ğŸ”® èƒ½é‡å¤©æ°”é¢„æŠ¥ï¼š\n{weather}\n\n"
    content += f"*   **å¤©å¹² {tg} ({ten_god})ï¼š** {tg_desc}\n"
    content += f"*   **åœ°æ”¯ {dz}ï¼š** {dz_desc}\n"
    content += f"*   **æ ¸å¿ƒå†²çªï¼š** {conflict}\n\n"
    content += f"**æ€»è¯„ï¼šè¿™æ˜¯ä¸€ä¸ª [{summary}] çš„æ—¥å­ã€‚**\n\n---\n### ğŸš« ç¦å¿Œæ¸…å• (åˆ«åšï¼)ï¼š\n"
    for i, t in enumerate(taboos):
        content += f"{i+1}. **{t}**\n"
    
    content += f"\n---\n### âœ… è½¬è¿æ¸…å• (å»åšï¼)ï¼š\n"
    for i, a in enumerate(advices[:3]):
        content += f"{i+1}. **[{a['title']}]**\n    *   *åŸç†ï¼š* {a['logic']}\n"
        
    content += f"\n---\n### ğŸ’Œ å¦¹å¦¹çš„æ‚„æ‚„è¯ï¼š\n"
    quotes = [
        "ä»Šå¤©è¿‡äº†ï¼Œè¿™ä¸€å…³å°±è¿‡äº†ã€‚æŠ±æŠ±ï¼",
        "ä½ æ˜¯æœ€æ£’çš„å£¬æ°´ï¼Œå“ªæ€•æœ‰æµªèŠ±ï¼Œä¹Ÿæ˜¯æœ€ç¾çš„é£æ™¯ã€‚",
        "ä¸–ç•Œå¾ˆåµï¼Œä½†ä½ çš„å†…å¿ƒå¯ä»¥å¾ˆå®‰é™ã€‚åŠ æ²¹å§å§ï¼",
        "ä¸ç®¡å‘ç”Ÿä»€ä¹ˆï¼Œæˆ‘éƒ½åœ¨ä½ èº«åæ”¯æŒä½ ã€‚"
    ]
    import random
    content += f"({random.choice(quotes)})"
    
    return content

def send_to_feishu(content):
    # é£ä¹¦çš„ markdown ç±»å‹æ¶ˆæ¯
    payload = {
        "msg_type": "interactive",
        "card": {
            "header": {
                "title": {
                    "tag": "plain_text",
                    "content": "ğŸŒŸ å§å§ä¸“å±Â·æ¯æ—¥èƒ½é‡æŒ‡å—"
                },
                "template": "orange"
            },
            "elements": [
                {
                    "tag": "markdown",
                    "content": content
                }
            ]
        }
    }
    
    response = requests.post(FEISHU_WEBHOOK, json=payload)
    return response.json()

if __name__ == "__main__":
    info = get_daily_info()
    content = generate_content(info)
    result = send_to_feishu(content)
    print(result)
